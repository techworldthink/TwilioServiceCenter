{% extends 'admin/admin_base.html' %}

{% block title %}{% if object %}Edit{% else %}Add{% endif %} Routing Rule{% endblock %}
{% block page_title %}{% if object %}Edit{% else %}Add New{% endif %} Routing Rule{% endblock %}

{% block content %}
<div class="admin-card" style="max-width: 600px;">
    <div class="admin-card-header">
        <h3 class="admin-card-title">{% if object %}Edit{% else %}Create{% endif %} Routing Rule</h3>
    </div>

    <div class="admin-card-body">
        <form method="post">
            {% csrf_token %}

            <div class="admin-alert admin-alert-info admin-alert-static" style="margin-bottom: 2rem;">
                <h4 style="margin-top: 0; font-size: 1rem;">How Routing Rules Work</h4>
                <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                    Routing rules determine which Twilio Account is used when sending a message or making a call to a
                    specific <strong>destination number</strong>.
                </p>
                <ul style="font-size: 0.9rem; padding-left: 1.25rem; margin-bottom: 0;">
                    <li><strong>Priority:</strong> Rules are checked in order (Lowest number first).</li>
                    <li><strong>Match Type:</strong> Choose "Starts with" for country codes (e.g., +1) or "Exact match"
                        for specific numbers.</li>
                    <li><strong>Outcome:</strong> The system picks the first matching account to process the request.
                    </li>
                    <li style="color: var(--admin-warning); margin-top: 0.25rem;"><strong>Note:</strong> These rules
                        are <strong>ignored</strong> if the used API Key has a "Forced Account" setting.</li>
                </ul>
            </div>

            <div class="admin-form-group">
                <label class="admin-form-label" for="{{ form.priority.id_for_label }}">
                    Priority *
                </label>
                {{ form.priority }}
                {% if form.priority.help_text %}
                <span class="admin-form-help">{{ form.priority.help_text }}</span>
                {% endif %}
                {% if form.priority.errors %}
                {% for error in form.priority.errors %}
                <span class="admin-form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Match Type Selection -->
            <div class="admin-form-group">
                <label class="admin-form-label" for="{{ form.match_type.id_for_label }}">
                    Match Type
                </label>
                {{ form.match_type }}
                <span class="admin-form-help">{{ form.match_type.help_text }}</span>
            </div>

            <!-- Simple Pattern Input -->
            <div class="admin-form-group" id="simple-pattern-group">
                <label class="admin-form-label" for="{{ form.simple_pattern.id_for_label }}">
                    {{ form.simple_pattern.label }} *
                </label>
                {{ form.simple_pattern }}
                <span class="admin-form-help">{{ form.simple_pattern.help_text }}</span>
                {% if form.simple_pattern.errors %}
                {% for error in form.simple_pattern.errors %}
                <span class="admin-form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Advanced Regex Input (Hidden by default) -->
            <div class="admin-form-group" id="regex-pattern-group" style="display: none;">
                <label class="admin-form-label" for="{{ form.pattern.id_for_label }}">
                    Pattern (Regex) *
                </label>
                {{ form.pattern }}
                {% if form.pattern.help_text %}
                <span class="admin-form-help">{{ form.pattern.help_text }}</span>
                {% endif %}
                {% if form.pattern.errors %}
                {% for error in form.pattern.errors %}
                <span class="admin-form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="admin-form-group">
                <label class="admin-form-label" for="{{ form.account.id_for_label }}">
                    Twilio Account *
                </label>
                {{ form.account }}
                {% if form.account.help_text %}
                <span class="admin-form-help">{{ form.account.help_text }}</span>
                {% endif %}
                {% if form.account.errors %}
                {% for error in form.account.errors %}
                <span class="admin-form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="admin-form-group">
                <label class="admin-form-label" for="{{ form.description.id_for_label }}">
                    Description
                </label>
                {{ form.description }}
                {% if form.description.help_text %}
                <span class="admin-form-help">{{ form.description.help_text }}</span>
                {% endif %}
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="admin-btn admin-btn-primary">
                    {% if object %}Update{% else %}Create{% endif %} Rule
                </button>
                <a href="{% url 'admin_dashboard:routing_rule_list' %}" class="admin-btn admin-btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const matchTypeSelect = document.getElementById('id_match_type');
        const simpleGroup = document.getElementById('simple-pattern-group');
        const regexGroup = document.getElementById('regex-pattern-group');

        function updateVisibility() {
            const value = matchTypeSelect.value;
            if (value === 'regex') {
                simpleGroup.style.display = 'none';
                regexGroup.style.display = 'block';
            } else {
                simpleGroup.style.display = 'block';
                regexGroup.style.display = 'none';
            }
        }

        // Initial state
        if (matchTypeSelect) {
            updateVisibility();
            matchTypeSelect.addEventListener('change', updateVisibility);
        }
    });
</script>
{% endblock %}